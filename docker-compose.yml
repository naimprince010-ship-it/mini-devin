version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: mini-devin-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-minidevin}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - mini-devin-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mini-devin:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        USERNAME: ${SANDBOX_USER:-minidevin}
    container_name: mini-devin-agent
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-minidevin}
      
      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      
      # Browser Search API Keys (optional)
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - SERPAPI_API_KEY=${SERPAPI_API_KEY:-}
      
      # Run Mode: offline | browse | interactive
      - RUN_MODE=${RUN_MODE:-offline}
      
      # Safety Configuration
      - MAX_ITERATIONS=${MAX_ITERATIONS:-50}
      - MAX_REPAIR_ITERATIONS=${MAX_REPAIR_ITERATIONS:-3}
      - ALLOW_DEPENDENCY_BUMP=${ALLOW_DEPENDENCY_BUMP:-false}
      - MAX_LINES_EDIT=${MAX_LINES_EDIT:-300}
      - MAX_FILES_DELETE=${MAX_FILES_DELETE:-1}
      
      # Artifact Configuration
      - ARTIFACT_DIR=${ARTIFACT_DIR:-/workspace/runs}
      - VERBOSE=${VERBOSE:-true}
      
      # Security Configuration
      - SANDBOX_ENABLED=${SANDBOX_ENABLED:-true}
      - NETWORK_ISOLATION=${NETWORK_ISOLATION:-false}
    volumes:
      # Mount workspace directory
      - ${WORKSPACE_DIR:-./workspace}:/workspace
      # Mount runs directory for artifacts
      - ${RUNS_DIR:-./runs}:/workspace/runs
      # Security: Mount tmp as tmpfs (in-memory, size-limited)
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: ${TMP_SIZE:-536870912}  # 512MB default
          mode: 1777
    working_dir: /workspace
    stdin_open: true
    tty: true
    # Security: Run as non-root user
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    # Security: Read-only root filesystem with specific writable paths
    read_only: ${READ_ONLY_ROOT:-false}
    # Security: Drop all capabilities and add only what's needed
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    # Security: Prevent privilege escalation
    security_opt:
      - no-new-privileges:true
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-2.0}'
          memory: ${MEMORY_LIMIT:-4G}
          pids: ${PID_LIMIT:-256}
        reservations:
          cpus: '0.5'
          memory: 512M
    # Security: Limit open files and processes
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 256
        hard: 512
    # Network configuration
    networks:
      - mini-devin-network
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: Selenium Grid for interactive browser mode
  selenium:
    image: selenium/standalone-chrome:latest
    container_name: mini-devin-selenium
    environment:
      - SE_NODE_MAX_SESSIONS=2
      - SE_NODE_SESSION_TIMEOUT=300
    ports:
      - "4444:4444"
      - "7900:7900"  # VNC viewer
    shm_size: 2gb
    networks:
      - mini-devin-network
    profiles:
      - interactive  # Only start with --profile interactive

networks:
  mini-devin-network:
    driver: bridge

volumes:
  postgres_data:
